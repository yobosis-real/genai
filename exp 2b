# Minimal spam detection with an autoencoder (train on HAM only)
import numpy as np
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.model_selection import train_test_split
from sklearn.metrics import classification_report
from tensorflow.keras.models import Model
from tensorflow.keras.layers import Input, Dense

# --- tiny dataset ---
messages = [
  ("ham","Hey are we still meeting today?"),
  ("spam","Congratulations! You've won a free iPhone. Click here!"),
  ("ham","Can you send the report by tonight?"),
  ("spam","You have been selected for a $1000 gift card!"),
  ("ham","Lunch at 1pm?"),
  ("spam","Claim your prize now!"),
  ("ham","Don't forget the meeting tomorrow."),
  ("ham","Let's catch up soon."),
  ("spam","Winner! Call now to claim your reward."),
  ("ham","I'll be late to the office today.")
]
labels, texts = zip(*messages)

# --- TF-IDF ---
vec = TfidfVectorizer()
X = vec.fit_transform(texts).toarray()
y = np.array([1 if lab=="spam" else 0 for lab in labels])   # spam=1, ham=0

# --- split (we'll train autoencoder using only HAM from training set) ---
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.3, random_state=42, stratify=y)
X_train_ham = X_train[y_train==0]

# --- tiny autoencoder ---
inp_dim = X.shape[1]
inp = Input(shape=(inp_dim,))
enc = Dense(16, activation="relu")(inp)
dec = Dense(inp_dim, activation="sigmoid")(enc)
ae = Model(inp, dec)
ae.compile(optimizer="adam", loss="mse")
ae.fit(X_train_ham, X_train_ham, epochs=30, batch_size=2, verbose=0)

# --- threshold from ham recon error (95th percentile) ---
recon_ham = ae.predict(X_train_ham)
mse_ham = np.mean((X_train_ham - recon_ham)**2, axis=1)
threshold = np.percentile(mse_ham, 95)
print(f"Threshold (95th pct ham MSE): {threshold:.6f}")

# --- predict on test set ---
recon_test = ae.predict(X_test)
mse_test = np.mean((X_test - recon_test)**2, axis=1)
y_pred = (mse_test > threshold).astype(int)

print("\nClassification report:")
print(classification_report(y_test, y_pred, target_names=["ham","spam"]))
