# -----------------------------
# Install dependencies
# -----------------------------
!pip install -q chromadb sentence-transformers transformers accelerate langchain-community langchain-core

# -----------------------------
# Imports
# -----------------------------
from langchain_core.documents import Document
from langchain_community.embeddings import HuggingFaceEmbeddings
from langchain_community.vectorstores import Chroma
from transformers import pipeline

# -----------------------------
# Knowledge base
# -----------------------------
text = """
CVE-2022-23397 is a remote code execution vulnerability in Apache Log4j.
Attackers exploit it using crafted log messages.

Port scanning is a reconnaissance technique to discover open ports and services.
It can be detected using IDS alerts, firewall logs, and abnormal traffic patterns.

PowerShell abuse indicates post-exploitation activity such as fileless malware,
persistence, and lateral movement in Windows systems.
"""

# -----------------------------
# Manual chunking
# -----------------------------
chunks = [text[i:i+200] for i in range(0, len(text), 180)]
documents = [Document(page_content=c) for c in chunks]

# -----------------------------
# Vector DB
# -----------------------------
embeddings = HuggingFaceEmbeddings(
    model_name="sentence-transformers/all-MiniLM-L6-v2"
)
db = Chroma.from_documents(documents, embeddings)

# -----------------------------
# Correct T5 pipeline
# -----------------------------
llm = pipeline(
    "text2text-generation",
    model="google/flan-t5-base",
    max_new_tokens=120
)

# -----------------------------
# Manual RAG QA
# -----------------------------
def ask(question):
    docs = db.similarity_search(question, k=2)
    context = " ".join(d.page_content for d in docs)
    prompt = f"Context:\n{context}\n\nQuestion: {question}\nAnswer:"
    answer = llm(prompt)[0]["generated_text"]
    print("Q:", question)
    print("A:", answer)
    print("-" * 60)

# -----------------------------
# Queries
# -----------------------------
ask("What is CVE-2022-23397?")
ask("How do I detect port scanning?")
ask("What does PowerShell abuse indicate?")
